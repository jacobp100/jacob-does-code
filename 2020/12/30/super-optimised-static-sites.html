<!DOCTYPE html><html lang="en"><head><title>Super Optimised Static Sites</title><meta charSet="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><script>document.documentElement.style.setProperty("--b",1/(window.devicePixelRatio||1)+"px");</script><style>@font-face{font-family:Inter;font-weight:100 900;font-display:swap;font-style:normal;font-named-instance:"Regular";src:url(/res/541fae2e.woff2);font-display:fallback}@font-face{font-family:Inter;font-weight:100 900;font-display:swap;font-style:italic;font-named-instance:"Regular";src:url(/res/1517082.woff2);font-display:fallback}*,::after,::before{box-sizing:border-box}*{font-size:calc(var(--c)*var(--d));line-height:calc(var(--e)*var(--d));letter-spacing:calc(var(--f)*var(--d));font-weight:var(--g);--d:calc(
    ((var(--h) * 1rem) + (1 - var(--h)) * 16px) /
    16
  )}@supports (font-variation-settings:"wght"400){*{font-weight:inherit;font-variation-settings:"wght"var(--g)}}:root{--i:#f97f51;--j:#fc427b;--k:#0652dd;--l:#2771f9;--m:var(--k);--n:#a3cb38;--o:#ed4c67;--a:var(--p);--p:black;--q:white;--r:12px;--s:12px;--h:1}::selection{background:var(--a);color:#fff}body{margin:var(--r) var(--s) 64px;--c:18;font-family:Inter,system-ui,-apple-system,sans-serif;color:var(--p);background:var(--q);--e:26}a{color:var(--a);text-decoration:none}a:active,a:focus,a:hover{text-decoration:underline}.a{display:flex;padding-top:12px;margin:-12px calc(-1*var(--s)) 48px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch}.a::after,.a::before{display:block;content:"";padding-right:var(--s)}.b,.c{flex:none;--g:700}.b{display:block;--c:24;--e:18;--f:-1;text-transform:lowercase;border-top:4px solid;padding:6px 4px 0 0}a.b{color:currentColor;text-decoration:none}.c{margin:0 0 0 24px;--c:6;--e:10;--f:1;--h:0;text-transform:uppercase;width:0}.e{margin-left:auto}.d{flex:none;display:block;margin:10px 24px 0 0;--c:14;--e:18;--g:400}.d:last-child{margin-right:0}@media (prefers-color-scheme:dark){:root{--m:var(--l);--p:white;--q:black}}@media (min-width:768px){:root{--s:64px}}@media (min-width:1024px){:root{--s:128px}}:root{--s:max(12px, (100vw - var(--t)) / 2);--t:800px;--a:var(--o)}h1{margin:48px 0 32px;--c:36;--e:48;--f:-0.8}h2,h3{margin:42px 0 18px}h1,h2{font-weight:700}h2{--c:26;--e:34;--f:-0.3}h3{--c:22;--e:30;--f:-0.18}p{margin:18px 0}a,p>code{word-break:break-all}h3,strong{font-weight:600}ol,ul{margin:24px 0;padding-left:32px;margin-left:calc(-32*min(max(var(--s) - 32px,0px),1px))}li{position:relative;margin:2px 0;list-style:none}li::before{position:absolute;content:var(--u, "ðŸ‘‰");right:calc(100% + 12px)}li[data-bullet]{--u:attr(data-bullet)}blockquote{margin:32px 24px 32px 48px;--c:22;--e:32;font-weight:300;font-style:italic}table{margin:24px;border-collapse:separate;border-spacing:12px 0}thead th{border-bottom:var(--b) solid;--g:600;text-align:left}code,hr{background-color:#f4f4f4}hr{margin:32px calc(-1*var(--s));height:var(--b);border:0}code{font-size:.9em;font-family:monospace;padding:0 3px;border:1px solid #eee;border-radius:6px}pre code{display:block;width:100vw;margin:48px calc(-1*var(--s));padding:18px var(--s);background-color:#fafafa;border:1px solid #f4f4f4;border-width:1px 0;border-radius:0;overflow-x:scroll}video{display:block;max-width:100%;margin:32px auto}iframe{width:calc(var(--v)*1);height:calc(var(--v)*.66);border:1px solid rgba(0,0,0,.1);--v:calc(100vw - 2 * var(--s))}.f,blockquote{color:#9e9e9e}@media (min-width:768px){a,p>code{word-break:initial}}@media (prefers-color-scheme:dark){hr,pre code{background-color:#080808}code{background-color:#111;border-color:#222}pre code{border-color:#111}}.-j,.-l{color:#a0a1a7;font-style:italic}.-e,.-m,.-n{color:#a626a4}.-f,.-o,.-p,.-q,.-r{color:#e45649}.-s{color:#0184bb}.-i,.-t,.-u,.-v,.-w{color:#50a14f}.-k,.-x .-y{color:#c18401}.-A,.-B,.-C,.-D,.-E,.-g,.-h,.-z{color:#986801}.-F,.-G,.-H,.-I,.-J,.-y{color:#4078f2}.-K{font-style:italic}.-L{font-weight:700}.-H{text-decoration:underline}@media (prefers-color-scheme:dark){.-j,.-l{color:#5c6370;font-style:italic}.-e,.-m,.-n{color:#c678dd}.-f,.-o,.-p,.-q,.-r{color:#e06c75}.-s{color:#56b6c2}.-i,.-t,.-u,.-v,.-w{color:#98c379}.-k,.-x .-y{color:#e6c07b}.-A,.-B,.-C,.-D,.-E,.-g,.-h,.-z{color:#d19a66}.-F,.-G,.-H,.-I,.-J,.-y{color:#61aeee}.-K{font-style:italic}.-L{font-weight:700}.-H{text-decoration:underline}}</style></head><body><div class="a"><a href="/" class="b">Jacob<br/>does<br/>code</a><div class="c">Apps</div><a href="/pocket-jam" class="d">Pocket Jam</a><a href="/piano-tabs" class="d">Piano Tabs</a><a href="/technicalc" class="d">TechniCalc</a><a href="/freebies" class="d">Freebies</a><div class="c e">Developement</div><a href="/blog" class="d">Blog</a><a href="https://github.com/jacobp100" class="d">Github</a></div><h1>Super Optimised Static Sites</h1>
<p>If you use GitHub pages, thereâ€™s a high chance youâ€™re also using Jekyll. The biggest thing Jekyll brings is templating â€” which is great both for developer speed and for getting consistency in your site.</p>
<p>Today, Jekyll is over 12 years old, and it does show its age in places. I wanted to see what was possible with todayâ€™s more modern tooling.</p>
<p>The toolchain makes heavy use <code>react-dom/server</code> and leverages a powerful custom component system that handles the siteâ€™s assets. While Iâ€™m not the first to do a static site system based on React, the custom component system is what sets it apart, and gives way to,</p>
<ul>
<li>React-based templating</li>
<li>Does not include React on the client (or any JS unless you want it)</li>
<li>Effortless compression/minification of images, CSS, and JS</li>
<li>Simple long term caching of assets</li>
<li>Granular control of how assets are used â€” including inlining critical CSS and JS</li>
<li>The <strong>best</strong> CSS optimisation available â€” Iâ€™ve not seen anything that comes close here</li>
</ul>
<p>Putting this all together makes the total page weight for the page youâ€™re currently on less than 100kb â€” and thatâ€™s including a 50kb font.</p>
<p>Firstly, React-based templating. This is basically the same as <a href="https://mdxjs.com">MDX</a>. You can include HTML and JSX inside your markdown,</p>
<pre><code>Some <span class="-K">_regular_</span> markdown

<span class="-M"><span class="-N">&lt;<span class="-p">ReactComponent</span>&gt;</span></span>

Some more <span class="-K">_regular_</span> markdown inside a React component

<span class="-M"><span class="-N">&lt;/<span class="-p">ReactComponent</span>&gt;</span></span>

<span class="-M"><span class="-N">&lt;<span class="-p">ReactComponentOnItsOwn</span> /&gt;</span></span>
</code></pre>
<p>This is run on the server at build-time and returns regular HTML, so the resulting file does not need JS to run, nor a server to pre-process it before sending it to a client.</p>
<h2>The Component System</h2>
<p>The markdown system is not particularly new, but it leads the way to the built-in components. These function as (mostly) drop-in replacements for the standard HTML components. For example to render an image, itâ€™s as simple as,</p>
<pre><code><span class="-M"><span class="-N">&lt;<span class="-p">Image</span> <span class="-z">src</span>=<span class="-t">&quot;/assets/some-image.png&quot;</span> /&gt;</span></span>
</code></pre>
<p>But behind the scenes, this loads the image, compresses it, converts it into multiple formats (webp etc.), and returns a <code>&lt;picture&gt;</code> element.</p>
<pre><code><span class="-N">&lt;<span class="-p">picture</span>&gt;</span>
  <span class="-N">&lt;<span class="-p">source</span> <span class="-z">srcset</span>=<span class="-t">&quot;/res/b462ccd1.webp&quot;</span> <span class="-z">type</span>=<span class="-t">&quot;image/webp&quot;</span> /&gt;</span>
  <span class="-N">&lt;<span class="-p">img</span> <span class="-z">src</span>=<span class="-t">&quot;/res/31f3d1bb.png&quot;</span> /&gt;</span>
<span class="-N">&lt;/<span class="-p">picture</span>&gt;</span>
</code></pre>
<p>Youâ€™ll notice the returned <code>src</code>s are hashes. Everything in the <code>/res</code> folder can be safely set with an indefinite cache policy, because if the file changes, its filename will too.</p>
<p>This also has a few more tricks up its sleeve. You may want to set the <code>width</code> and <code>height</code> attributes on the image to avoid layout shifts (<a href="https://www.smashingmagazine.com/2020/03/setting-height-width-images-important-again/">article</a>). This is as easy as,</p>
<pre><code><span class="-M"><span class="-N">&lt;<span class="-p">Image</span> <span class="-z">src</span>=<span class="-t">&quot;/assets/some-image.png&quot;</span> <span class="-z">width</span>=<span class="-t">&quot;compute&quot;</span> <span class="-z">height</span>=<span class="-t">&quot;compute&quot;</span> /&gt;</span></span>
</code></pre>
<p>(We try to maintain as much compatibility as possible with the original HTML elements here)</p>
<p>And if you know your image is probably too big, and you want to resize it to at most 1000px wide?</p>
<pre><code><span class="-M"><span class="-N">&lt;<span class="-p">Image</span> <span class="-z">src</span>=<span class="-t">&quot;/assets/some-image.png&quot;</span> <span class="-z">resize</span>=<span class="-t">&quot;1000w&quot;</span> /&gt;</span></span>
</code></pre>
<p>As the components are standard React components, youâ€™re not limited to only using them in your markdown.You can also use them in your own React components or page layouts.</p>
<pre><code><span class="-j">// components/ExampleComponent.js</span>

<span class="-e">import</span> { <span class="-y -O">Image</span> } <span class="-e">from</span> <span class="-t">&quot;../core/components&quot;</span>;

<span class="-e">export</span> <span class="-e">default</span> ({ src, chlidren }) =&gt; (
  <span class="-M"><span class="-N">&lt;<span class="-p">div</span> <span class="-z">style</span>=<span class="-t">{{</span> <span class="-z">display:</span> &quot;<span class="-z">flex</span>&quot; }}&gt;</span>
    <span class="-N">&lt;<span class="-p">Image</span> <span class="-z">src</span>=<span class="-t">&quot;src&quot;</span> /&gt;</span>
    {children}
  <span class="-N">&lt;/<span class="-p">div</span>&gt;</span></span>
);
</code></pre>
<p>When you are doing your own page layout, youâ€™ll also find the following components useful:</p>
<ul>
<li><code>&lt;InlineCss&gt;</code> and <code>&lt;ExternalCss&gt;</code> â€” renders <code>&lt;style&gt;</code> and <code>&lt;link&gt;</code> elements, respectively</li>
<li><code>&lt;InlineJs&gt;</code> and <code>&lt;ExternalJs&gt;</code> â€” both render <code>&lt;script&gt;</code> elements</li>
</ul>
<pre><code><span class="-j">// layouts/example-layout.js</span>

<span class="-e">import</span> { <span class="-y -O">InlineCss</span>, <span class="-y -O">ExternalJs</span> } <span class="-e">from</span> <span class="-t">&quot;../core/components&quot;</span>;

<span class="-e">export</span> <span class="-e">default</span> ({ title, children }) =&gt; (
  <span class="-M"><span class="-N">&lt;<span class="-p">html</span>&gt;</span>
    <span class="-N">&lt;<span class="-p">head</span>&gt;</span>
      <span class="-N">&lt;<span class="-p">title</span>&gt;</span>{title ?? &quot;No title&quot;}<span class="-N">&lt;/<span class="-p">title</span>&gt;</span>
      <span class="-N">&lt;<span class="-p">meta</span> <span class="-z">charSet</span>=<span class="-t">&quot;utf-8&quot;</span> /&gt;</span>
      <span class="-N">&lt;<span class="-p">InlineCss</span> <span class="-z">src</span>=<span class="-t">&quot;/assets/site.css&quot;</span> /&gt;</span>
    <span class="-N">&lt;/<span class="-p">head</span>&gt;</span>
    <span class="-N">&lt;<span class="-p">body</span>&gt;</span>
      {children}
      <span class="-N">&lt;<span class="-p">ExternalJs</span> <span class="-z">src</span>=<span class="-t">&quot;/assets/site.js&quot;</span> /&gt;</span>
    <span class="-N">&lt;/<span class="-p">body</span>&gt;</span>
  <span class="-N">&lt;/<span class="-p">html</span>&gt;</span></span>
);
</code></pre>
<p>As youâ€™d expect, the CSS and JS you pass in are optimised with csso and terser, respectively. And like the images, the files generated from <code>&lt;ExternalCss&gt;</code> and <code>&lt;ExternalJs&gt;</code> are named using the output hash, so can be cached indefinitely.</p>
<p>These components make it super-simple to decide what assets you load in a page, and how they get loaded.</p>
<h2>CSS</h2>
<p>For authoring CSS, it is all plain CSS. Thereâ€™s no CSS-in-JS or CSS modules. The focus here was to produce the best CSS output available.</p>
<p>For example, open your web inspector on this code block, and look at the highlighting below,</p>
<pre><code><span class="-N">&lt;<span class="-p">just-some</span> <span class="-z">random</span>=<span class="-t">&quot;code&quot;</span>&gt;</span>
  to
  <span class="-j">&lt;!-- demonstrate highlighting --&gt;</span>
<span class="-N">&lt;/<span class="-p">just-some</span>&gt;</span>
</code></pre>
<p>You could equally look anywhere else on the site. The class names are shortâ€¦ Too shortâ€¦</p>
<p>The CSS wasnâ€™t written this way: class names (and CSS custom properties) get minified as part of the build process.</p>
<p>For your CSS files, this happens automatically as part of the minification process.</p>
<p>For HTML (not React components) in your markdown, this also happens automatically.</p>
<p>For React components, youâ€™ll need to use the <code>classNames</code> helper. It works similar to the <a href="https://www.npmjs.com/package/classnames">classnames</a> package â€” but it also does the minification.</p>
<pre><code><span class="-j">// components/ExampleComponent.js</span>

<span class="-e">import</span> { <span class="-y -O">Image</span> } <span class="-e">from</span> <span class="-t">&quot;../core/components&quot;</span>;
<span class="-e">import</span> { classNames } <span class="-e">from</span> <span class="-t">&quot;../core/css&quot;</span>;

<span class="-e">export</span> <span class="-e">default</span> ({ src, inverted }) =&gt; (
  <span class="-M"><span class="-N">&lt;<span class="-p">div</span>
    <span class="-z">className</span>=<span class="-t">{classNames([</span>
      &quot;<span class="-z">hero-section</span>&quot;,
      <span class="-z">inverted</span> &amp;&amp; &quot;<span class="-z">hero-section--inverted</span>&quot;,
    ])}
  &gt;</span>
    <span class="-N">&lt;<span class="-p">p</span> <span class="-z">className</span>=<span class="-t">{classNames(</span>&quot;<span class="-z">paragraph</span> <span class="-z">paragraph--large</span>&quot;)}&gt;</span>
      A large paragraph
    <span class="-N">&lt;/<span class="-p">p</span>&gt;</span>
    {/*
     * Note that built-in components apply the `classNames` helper themselves
     * Make sure you don&#x27;t double apply it!
     */}
    <span class="-N">&lt;<span class="-p">Image</span> <span class="-z">src</span>=<span class="-t">{src}</span> <span class="-z">className</span>=<span class="-t">&quot;hero-section__image&quot;</span> /&gt;</span>
  <span class="-N">&lt;/<span class="-p">div</span>&gt;</span></span>
);
</code></pre>
<p>If you reference class names or custom properties from your JS files, youâ€™ll need to use the global-like constants, <code>CSS_CLASSES</code> and <code>CSS_VARS</code>:</p>
<pre><code><span class="-j">// assets/example.js</span>

<span class="-e">const</span> heroSection = <span class="-A -P">document</span>.<span class="-y -Q">querySelector</span>(<span class="-t">&quot;.&quot;</span> + <span class="-A -R">CSS_CLASSES</span>[<span class="-t">&quot;hero-section&quot;</span>]);
<span class="-e">const</span> heroSection.<span class="-S">style</span>.<span class="-y -Q">setProperty</span>(
  <span class="-A -R">CSS_VARS</span>[<span class="-t">&quot;--some-css-var&quot;</span>],
  <span class="-t">&quot;some-value&quot;</span>
)
</code></pre>
<p>This approach has two benefits. The first is the compression already mentioned. The second is that by doing this, we build a list of where class names are defined and where theyâ€™re used. After weâ€™ve built the site, we can compare them to see if youâ€™ve added a class thatâ€™s not used, or used class that was never defined.</p>
<p>For example, on this site, I get a few warnings from the syntax highlighting:</p>
<pre><code>The following classes were defined in CSS, but never used in any non-CSS files:

hljs-quote, hljs-doctag, hljs-formula, hljs-section, hljs-selector-tag, hljs-subst, hljs-regexp, hljs-attribute, hljs-variable, hljs-template-variable, hljs-type, hljs-selector-class, hljs-selector-attr, hljs-selector-pseudo, hljs-symbol, hljs-bullet, hljs-link, hljs-selector-id, hljs-emphasis, hljs-strong

The following classes used one more non-CSS files, but never defined in CSS:

hljs, language-diff, language-objc, language-objectivec, hljs-meta-keyword, twitter-tweet, language-jsx, hljs-function, xml, hljs-tag, hljs-params, language-xml, language-c#, language-reasonml, hljs-operator, hljs-module-access, hljs-module, hljs-identifier, hljs-constructor, hljs-pattern-match
</code></pre>
<p>Thatâ€™s quite a list! For the first set warnings, I could go through and remove them from the highlighting CSS â€” although there is a maintainance overhead for ensuring I add them back if they do become used.</p>
<p>For the second set of warnings, thereâ€™s not much I can do, sice these are generated from the highlighter.</p>
<p>However, I can tell you that as soon as I implemented these warnings, I got one warning in each category that was down to my own code. It meant I could safely delete some code, resulting in an even smaller site. I would almost certainly not have realised the issues without the help of the warnings.</p>
<h2>Project Status</h2>
<p>All the site generation code is contained in the repo for this site. Itâ€™s not published as a stand-alone package.</p>
<p><a href="https://github.com/jacobp100/jacob-does-code">Jacob Does Code on GitHub</a></p>
<p>If you wanted to use the code, you should be able to fork it, delete everything in all the folders except <code>/core</code>, and then add your own content as necessary.</p>
<p>Run <code>yarn build</code> to build the production version of the site. Itâ€™s output to <code>/site</code>.</p>
<p>Run <code>yarn start</code> to run a development server. This will watch files for changes and rebuild when necessary, and you can press <code>r</code> to force a full rebuild. You can see your site on port <code>8080</code>. It skips most minification steps for performance or developer ergonomic reasons.</p>
<p>The development server is quite good at only compiling the things that changed. Half of this is down to aggressively checking dependencies for what was used on each page, then only rebuilding the pages that need to be rebuilt. The other half of this is down to caching, so if you render an <code>&lt;Image&gt;</code> component, the computationally-intensive parts get cached and re-used on subsequent page renders.</p>
<p>When writing this blog, each recompilation is completing in 0.1â€“0.2s on a 6 year old laptop.</p>
<p>The caveat to the change detection is any changes in React components need a restart of the server to clear Nodeâ€™s module cache. This is something that can probably be fixed, but I havenâ€™t done it.</p>
<p>I donâ€™t have too much interest in (or time for) publishing and maintaining this as a stand-alone project myself. However, if you are, youâ€™re absolutely free to. Consider all the code in <code>/core</code> under the MIT license â€” i.e. anything thatâ€™s not my literal site. If you need any help with the code, youâ€™re more than welcome to reach out to me too.</p><span class="f">Published on <time dateTime="2020-12-30T00:00:00.000Z">30th December 2020</time></span></body></html>